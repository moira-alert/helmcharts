---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.topology.api.name }}-configmap
  labels:
    helm.sh/chart: {{ include "moira.chart" . }}
    app.kubernetes.io/name: {{ .Values.topology.api.name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
data:
  api.yml: |
    {{- if .Values.datasources.redis}}
    redis:
      {{- toYaml .Values.datasources.redis | nindent 6 }}
    {{- end }}
    {{- if .Values.log }}
    log:
      {{- toYaml .Values.logger | nindent 6 }}
    {{- end }}
    {{- if .Values.microservices.api }}
    api:
      {{- toYaml .Values.microservices.api | nindent 6 }}
    {{- end }}
    {{- if .Values.microservices.web }}
    web:
      {{- omit  .Values.microservices.web "contacts_template" "contacts" | toYaml | nindent 6 }}
      {{- if .Values.microservices.web.contacts }}
      contacts:
      {{- range $key, $value := .Values.microservices.web.contacts }}
        - contact: {{ $key }}
          {{- range $elem, $elemVal := $value }}
          {{ $elem }}: {{ $elemVal }}
          {{- end }}
      {{- end }}
      {{- end }}
      {{- if .Values.microservices.web.contacts }}
      contacts_template:
      {{- range $key, $value := .Values.microservices.web.contacts_template }}
        - contact: {{ $key }}
      {{- range $elem, $elemVal := $value }}
          {{ $elem }}: {{ $elemVal | quote }}
          {{- end }}
      {{- end }}
      {{- end }}
    {{- end }}
    {{- if .Values.telemetry }}
    telemetry:
      {{- toYaml .Values.telemetry | nindent 6 }}
    {{- end }}
    {{- if .Values.datasources.graphite_remote}}
    graphite_remote:
      {{- toYaml .Values.datasources.graphite_remote | nindent 6 }}
    {{- end }}
    {{- if .Values.datasources.prometheus_remote}}
    prometheus_remote:
      {{- toYaml .Values.datasources.prometheus_remote | nindent 6 }}
    {{- end }}
